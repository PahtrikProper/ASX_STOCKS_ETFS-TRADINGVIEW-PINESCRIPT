#DO NOT USE THIS WITHOUT OPTIMISING YOUR PARAMTERS FIRST USING THE PYTHON SCRIPT IN THIS REPOSITORY, THEN MANUALLY FINE TUNE IN TRADINGVIEW USING THE GUI FOR PAST 30 DAYS OR 1 WEEK DEPENDING ON MARKET DIRECTION
# THIS IS GREAT FOR EXITS AND ENCOURAGING YOU TO STAY OUT OF THE MARKET. DON'T ALWAYS BELIEVE THE ENTRIES!
# THIS IS THE ORIGINAL, USE THIS FIRST


//@version=6
strategy("Triple EMA Long, ASX, Any Timeframe, TP/SL Optimized",
     shorttitle="Triple-EMA Optimized ASX",
     overlay=true, initial_capital=100, currency=currency.AUD,
     default_qty_type=strategy.percent_of_equity, default_qty_value=100,
     pyramiding=0, calc_on_every_tick=true, process_orders_on_close=false,
     commission_type=strategy.commission.percent, commission_value=0.2,
     slippage=1, margin_long=100, margin_short=100)

// === USER OPTIMIZATION INPUTS ===
fastLen   = input.int(2,   "Fast EMA",  minval=2,  maxval=20,  step=1)
midLen    = input.int(50,  "Mid EMA",   minval=10, maxval=50,  step=1)
slowLen   = input.int(80,  "Slow EMA",  minval=40, maxval=100, step=1)
trendLen  = input.int(66,  "Trend SMA", minval=20, maxval=150, step=5)
tpPct     = input.float(8.0, "Take Profit %", step=0.1, minval=0.5, maxval=55)
slPct     = input.float(8.0, "Stop Loss %",  step=0.1, minval=0.5, maxval=15)
trendBars = input.int(4, "TP/SL Trend Bars", minval=2, maxval=10)

// === MAIN INDICATORS ===
fast  = ta.ema(close, fastLen)
mid   = ta.ema(close, midLen)
slow  = ta.ema(close, slowLen)
trend = ta.sma(close, trendLen)

// === HELPER FUNCTIONS ===
future_tp(i) => close[i] * (1 + tpPct / 100)
future_sl(i) => close[i] * (1 - slPct / 100)

// === TREND CONSISTENCY CHECK ===
tp_up = true
sl_up = true
for i = 0 to trendBars - 2
    if future_tp(i) <= future_tp(i+1)
        tp_up := false
    if future_sl(i) <= future_sl(i+1)
        sl_up := false
trendCondition = tp_up and sl_up

// === ENTRY & EXIT CONDITIONS ===
crossUp   = ta.crossover(fast, mid)
crossDown = ta.crossunder(fast, mid)
trendOK   = mid > slow and close > trend
enter     = crossUp and trendOK and trendCondition

// === DYNAMIC TP & SL ===
longTP = strategy.position_avg_price * (1 + tpPct / 100)
longSL = strategy.position_avg_price * (1 - slPct / 100)

// === ORDERS ===
if enter and strategy.position_size == 0
    strategy.entry("Long", strategy.long)

if strategy.position_size > 0
    strategy.exit("Exit Long", "Long", limit=longTP, stop=longSL)

if crossDown and strategy.position_size > 0
    strategy.close("Long", comment="CrossDownExit")

// === PLOTS ===
plot(fast,  "Fast EMA",  color=color.orange)
plot(mid,   "Mid EMA",   color=color.blue)
plot(slow,  "Slow EMA",  color=color.red)
plot(trend, "Trend SMA", color=color.gray)
plot(strategy.position_size > 0 ? longTP : na, "Take Profit", color=color.new(color.green, 0), linewidth=2)
plot(strategy.position_size > 0 ? longSL : na, "Stop Loss",   color=color.new(color.red, 0),   linewidth=2)
plotshape(enter, title="â–² Entry", style=shape.triangleup, location=location.belowbar, size=size.tiny, color=color.new(color.green, 0))

// === VOLUME-COLOR CANDLES (GLOBAL SCOPE FIXED) ===
showVolumeCandles = input.bool(true, "Show Volume-Colored Candles")

// Compute average and ratio
volAvg   = ta.sma(volume, 20)
volRatio = volume / volAvg

// Volume-based candle color
volColor = volRatio > 1.5 ? color.new(color.lime, 0) :
           volRatio > 1.0 ? color.new(color.yellow, 0) :
           color.new(color.red, 0)

// Only plot candles if enabled
plotcandle(showVolumeCandles ? open : na, showVolumeCandles ? high : na, showVolumeCandles ? low : na, showVolumeCandles ? close : na, title="Volume Candles", color=showVolumeCandles ? volColor : na)
